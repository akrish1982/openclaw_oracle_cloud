#cloud-config
# =============================================================================
# Cloud-Init: Bootstrap OpenClaw + Ollama on Ubuntu 22.04 ARM64
# =============================================================================

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - jq
  - unzip
  - htop
  - tmux
  - ufw
  - ca-certificates
  # Python 3 (for scripts and skills)
  - python3
  - python3-pip
  - python3-venv
  # Playwright/Chromium browser dependencies (headless browser automation)
  - libnss3
  - libatk-bridge2.0-0
  - libdrm2
  - libxkbcommon0
  - libxcomposite1
  - libxdamage1
  - libxfixes3
  - libxrandr2
  - libgbm1
  - libasound2
  - libpango-1.0-0
  - libcairo2
  - libcups2
  - libatspi2.0-0
  - libxshmfence1

# --- Open iptables for OCI (Ubuntu requires this in addition to security lists) ---
runcmd:
  # ============================================================
  # 1. Fix OCI iptables (Ubuntu images block traffic by default)
  # ============================================================
  - iptables -F
  - iptables -P INPUT ACCEPT
  - iptables -P FORWARD ACCEPT
  - iptables -P OUTPUT ACCEPT
  - netfilter-persistent save || true

  # ============================================================
  # 2. Install Node.js 22 LTS (required for OpenClaw)
  # ============================================================
  - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
  - apt-get install -y nodejs
  - node --version
  - npm --version

  # ============================================================
  # 3. Install Ollama
  # ============================================================
  - curl -fsSL https://ollama.com/install.sh | sh
  - systemctl enable ollama
  - systemctl start ollama
  # Wait for Ollama to be ready
  - sleep 10
  # Pull the default model (runs in background)
  - |
    nohup ollama pull ${ollama_model} > /var/log/ollama-pull.log 2>&1 &

  # ============================================================
  # 4. Install and configure Tailscale
  # ============================================================
  - curl -fsSL https://tailscale.com/install.sh | sh
  - |
    if [ -n "${tailscale_auth_key}" ]; then
      tailscale up --authkey="${tailscale_auth_key}" --hostname=openclaw-oci --ssh
      echo "✓ Tailscale connected (hostname: openclaw-oci)"
    else
      echo "⚠ No Tailscale auth key provided. Run 'tailscale up' manually after SSH."
    fi

  # ============================================================
  # 5. Create dedicated openclaw user
  # ============================================================
  - useradd -m -s /bin/bash openclaw
  - usermod -aG sudo openclaw

  # ============================================================
  # 6. Write the setup script
  # ============================================================
  - |
    cat > /home/ubuntu/setup-openclaw.sh << 'SETUP_SCRIPT'
    #!/bin/bash
    set -euo pipefail

    echo "============================================"
    echo "  OpenClaw Setup Script"
    echo "  Oracle Cloud ARM64 Instance"
    echo "============================================"

    # --- Verify prerequisites ---
    echo "[1/7] Checking prerequisites..."
    node --version || { echo "ERROR: Node.js not found"; exit 1; }
    ollama --version || { echo "ERROR: Ollama not found"; exit 1; }
    python3 --version || { echo "ERROR: Python3 not found"; exit 1; }
    echo "✓ Node.js, Ollama, and Python3 installed"

    # --- Install OpenClaw ---
    echo "[2/7] Installing OpenClaw..."
    if ! command -v openclaw &>/dev/null; then
      npm install -g openclaw
      echo "✓ OpenClaw installed"
    else
      echo "✓ OpenClaw already installed"
    fi
    openclaw --version

    # --- Install Playwright for browser automation ---
    echo "[3/7] Installing Playwright + Chromium (headless browser)..."
    npm install -g playwright
    npx playwright install chromium
    echo "✓ Playwright + Chromium installed"

    # --- Install ClawHub and skills ---
    echo "[4/7] Installing ClawHub and skills..."
    npm install -g clawhub

    # Create skills directory for the openclaw user
    mkdir -p /home/openclaw/.openclaw/skills

    # Install skills (as openclaw user so they land in the right place)
    cd /home/openclaw/.openclaw/skills
    clawhub install chirp               # Twitter/X posting and replies
    clawhub install pinch-to-post       # Cross-post to Twitter, LinkedIn, Mastodon
    clawhub install openai-image-gen    # Image generation via OpenAI
    clawhub install fal-ai              # Image/video generation via fal.ai
    clawhub install mailchannels        # Send emails
    clawhub install autofillin          # Browser form automation
    clawhub install python              # Python coding guidelines
    clawhub install skill-creator       # Create new custom skills
    chown -R openclaw:openclaw /home/openclaw/.openclaw
    echo "✓ ClawHub and skills installed"

    # --- Wait for Ollama model to finish pulling ---
    echo "[5/7] Checking Ollama model status..."
    echo "  (This may take a while if the model is still downloading)"
    while ! ollama list | grep -q "${split(":", ollama_model)[0]}"; do
      echo "  Waiting for model download..."
      sleep 30
    done
    echo "✓ Ollama model ready"

    # --- Set up systemd service for OpenClaw ---
    echo "[6/7] Creating systemd service...
    cat > /etc/systemd/system/openclaw-gateway.service << 'SYSTEMD'
    [Unit]
    Description=OpenClaw Gateway
    After=network.target ollama.service
    Wants=ollama.service

    [Service]
    Type=simple
    User=openclaw
    WorkingDirectory=/home/openclaw
    ExecStart=/usr/bin/openclaw gateway run
    Restart=always
    RestartSec=30
    Environment=NODE_ENV=production
    Environment=HOME=/home/openclaw

    [Install]
    WantedBy=multi-user.target
    SYSTEMD

    systemctl daemon-reload
    echo "✓ Systemd service created"

    # --- Create cron job to restart gateway (stability) ---
    echo "[7/7] Setting up health check cron..."
    cat > /etc/cron.d/openclaw-health << 'CRON'
    # Restart OpenClaw gateway if it's not responding (every 30 min)
    */30 * * * * root systemctl is-active --quiet openclaw-gateway || systemctl restart openclaw-gateway
    CRON
    echo "✓ Health check cron installed"

    echo ""
    echo "============================================"
    echo "  Setup Complete!"
    echo "============================================"
    echo ""
    echo "Next steps:"
    echo "  1. Switch to openclaw user:  sudo su - openclaw"
    echo "  2. Run onboarding wizard:    openclaw onboard"
    echo "     - Select Anthropic + OpenRouter as providers"
    echo "     - Paste your API keys when prompted"
    echo "     - Select Telegram as your channel"
    echo "     - Paste your Telegram bot token"
    echo ""
    echo "  OR manually configure:"
    echo "  3. Copy config template:     cp /home/ubuntu/openclaw-config.json ~/.openclaw/openclaw.json"
    echo "  4. Edit with your API keys:  nano ~/.openclaw/openclaw.json"
    echo "  5. Start the gateway:        openclaw gateway run"
    echo "     (or: sudo systemctl start openclaw-gateway)"
    echo ""
    echo "  6. Open Telegram, message your bot, get pairing code"
    echo "  7. Approve pairing:          openclaw pair approve telegram <CODE>"
    echo ""
    SETUP_SCRIPT

    chmod +x /home/ubuntu/setup-openclaw.sh

  # ============================================================
  # 7. Write the OpenClaw config template
  # ============================================================
  - |
    cat > /home/ubuntu/openclaw-config.json << 'CONFIG'
    {
      "gateway": {
        "bind": "loopback",
        "tailscale": {
          "mode": "serve",
          "resetOnExit": true
        },
        "auth": {
          "allowTailscale": true
        }
      },
      "models": {
        "mode": "merge",
        "providers": {
          "ollama": {
            "baseUrl": "http://127.0.0.1:11434/v1",
            "api": "openai-completions",
            "models": [
              {
                "id": "ollama/${ollama_model}",
                "name": "Local Ollama (${ollama_model})",
                "contextWindow": 65536,
                "maxTokens": 8192
              }
            ]
          },
          "anthropic": {
            "apiKey": "${anthropic_api_key}",
            "models": [
              {
                "id": "anthropic/claude-sonnet-4-5",
                "name": "Claude Sonnet 4.5",
                "contextWindow": 200000,
                "maxTokens": 8192
              },
              {
                "id": "anthropic/claude-haiku-4-5",
                "name": "Claude Haiku 4.5 (fast/cheap)",
                "contextWindow": 200000,
                "maxTokens": 4096
              }
            ]
          },
          "openrouter": {
            "baseUrl": "https://openrouter.ai/api/v1",
            "apiKey": "${openrouter_api_key}",
            "api": "openai-completions",
            "models": [
              {
                "id": "openrouter/moonshotai/kimi-k2.5",
                "name": "Kimi K2.5",
                "contextWindow": 131072,
                "maxTokens": 8192
              }
            ]
          }
        }
      },
      "agents": {
        "defaults": {
          "model": {
            "primary": "anthropic/claude-sonnet-4-5",
            "fallbacks": [
              "openrouter/moonshotai/kimi-k2.5",
              "ollama/${ollama_model}"
            ]
          },
          "heartbeat": {
            "every": "30m",
            "model": "ollama/${ollama_model}"
          },
          "subagents": {
            "model": "openrouter/moonshotai/kimi-k2.5",
            "maxConcurrent": 1,
            "archiveAfterMinutes": 60
          },
          "models": {
            "anthropic/claude-sonnet-4-5": { "alias": "claude" },
            "anthropic/claude-haiku-4-5": { "alias": "haiku" },
            "openrouter/moonshotai/kimi-k2.5": { "alias": "kimi" },
            "ollama/${ollama_model}": { "alias": "local" }
          }
        }
      },
      "channels": {
        "telegram": {
          "enabled": true,
          "botToken": "${telegram_bot_token}"
        }
      },
      "skills": {
        "install": {
          "preferBrew": false,
          "nodeManager": "npm"
        },
        "entries": {
          "chirp": {
            "enabled": true
          },
          "pinch-to-post": {
            "enabled": true
          },
          "openai-image-gen": {
            "enabled": true
          },
          "fal-ai": {
            "enabled": true
          },
          "mailchannels": {
            "enabled": true
          },
          "autofillin": {
            "enabled": true
          },
          "python": {
            "enabled": true
          },
          "skill-creator": {
            "enabled": true
          }
        }
      }
    }
    CONFIG

    chown ubuntu:ubuntu /home/ubuntu/openclaw-config.json
    chown ubuntu:ubuntu /home/ubuntu/setup-openclaw.sh

  # ============================================================
  # 8. Keep instance active (prevent OCI reclamation)
  # ============================================================
  - |
    cat > /etc/cron.d/oci-keepalive << 'KEEPALIVE'
    # Generate small CPU load to prevent OCI from reclaiming idle instance
    */5 * * * * root dd if=/dev/urandom bs=1M count=10 of=/dev/null 2>/dev/null; sleep 2
    KEEPALIVE

final_message: |
  ==============================================
  Cloud-init complete!
  SSH in and run: sudo bash /home/ubuntu/setup-openclaw.sh
  ==============================================
